---
title: "data analysis"
author: "pengzhuobing"
date: "2021/6/4"
output:
  html_document: default
  pdf_document: default
---

> * 剔除ICT取样时间>50w的样本进行分析 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load fucntions
library(ggplot2)
library(dplyr)
library(reshape2)
library(pheatmap)
library(plyr)
library(RColorBrewer)
library(patchwork)
library(optmatch)
library(ggsignif)
library(ggpubr)
library(psych)
library(vegan) 
library(ape)

source("./TEST.functions.R") #这里加载写好的功能，后面用到的ttFun，tkFun
source("./common.R")
do.write <- F
load("../Result/04.Globalview/g2g.compare.RData")
load("../Result/04.Globalview/3.Permanova/gene.genus.mgs.79.bray.dist.RData")
load("../Result/01.Profile/relDaysgroups.RData")
color_heatmap_bule_red <- c("#7E1712","#bd2113","#e3460c","#f07701","#f59525","#fccbb8","#f5e13a","#a3e2e1","#6ab7e1","#4f74bb","#472497") 

```


## 受试者表型分析
```{r, warning=FALSE}

#phenotype
load("../Result/01.Profile/phe.RData")
phe <- phe.210701%>%filter(Fecal.sample.name%in%fecn.w50) # 剔除样本
phe$Sample.collection.time <-  as.Date(phe$Sample.collection.time, format = "%Y/%m/%d")
#phe$Sampling.pre.post.treatment.w. <- as.numeric(phe$Sampling.pre.post.treatment.w.)
phe$Sampling.post.treatment.w. <- as.numeric(phe$Sampling.post.treatment.w.)
#phe$First_Treatment.duration <- as.Date(phe$First_Treatment.duration, format = "%Y/%m/%d")
#phe$First_Treatment.duration <- as.Date(phe$First_Treatment.duration, format = "%Y/%m/%d")
#phe$Sampling.post.treatment.w. <- phe$Sample.collection.time-phe$First_Treatment.duration
#phe$Sampling.post.treatment.w. <- as.numeric(phe$Sampling.post.treatment.w.)
phe$Antibiotic <- ifelse(phe$Antibiotic.use=="No","No","Yes")


fp <- phe%>%filter(sample_order!="2"&sample_order!="3")
fp <- fp[order(fp$Sampling.post.treatment.w.),]
phe$Patient.ID <- factor(phe$Patient.ID, levels=rev(fp$Patient.ID))

fp <- fp[order(fp$Drug_type),]
phe$Patient.ID <- factor(phe$Patient.ID, levels=rev(fp$Patient.ID))

p10 <- ggplot(phe, aes(x=Sampling.post.treatment.w., y=Patient.ID, color =Drug_type, shape =  BE2)) + theme(axis.text.x = element_text(angle = 30, hjust = 1)) +geom_point(size = 3) + geom_line(aes(group=Patient.ID), linetype="dashed", col="black") +theme_bw() + 
  xlab("Weeks relative to initiation of treatment") + ylab("Patient ID")

p10

if(do.write){
  ggsave(p10, filename = "../Result/04.Globalview/sampleInfo/exICT50w/g10.sample.stat.BE2.pdf",width = 7, height = 8)
}

# 样本排序
fp <- fp[order(fp$Sampling.post.treatment.w.),]
phe$Patient.ID <- factor(phe$Patient.ID, levels=rev(fp$Patient.ID))

fp <- fp[order(fp$Group),]
phe$Patient.ID <- factor(phe$Patient.ID, levels=rev(fp$Patient.ID))
p5 <- ggplot(phe, aes(x=Sampling.post.treatment.w., y=Patient.ID, color = BE2, shape=Group))+ theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  geom_point(size = 3) + geom_line(aes(group=Patient.ID), linetype="dashed", col="black")  + 
  xlab("Weeks relative to initiation of treatment") + ylab("Patient ID")+theme_bw()#+facet_grid(Group~.,scale="free_y",space="free")
p5
# geom_line(aes(group=Patient.ID), linetype="dashed") 

if(do.write){
  ggsave(p5, filename = "../Result/04.Globalview/sampleInfo/exICT50w/g5.sample.stat.BE2.pdf",width = 7, height = 8)
}

```

## 受试者两次取样1：2之间的相关性

```{r}
p12 <- phe%>%filter(sample_order=="1"|sample_order=="2")
p.1 <- p12%>%filter(sample_order=="1")
p.2 <- p12%>%filter(sample_order=="2")

p1a2 <- phe$Patient.ID
p.1.bray.dist <- All.genus.79.bray.dist[p.1$Fecal.sample.name, p.1$Fecal.sample.name]
p.2.bray.dist <- All.genus.79.bray.dist[p.2$Fecal.sample.name, p.2$Fecal.sample.name]
p.1.bray.dist.xx <- reshapeDist(p.1.bray.dist,p.1,"Fecal.sample.name","Group","BE2")
p.1.bray.dist.xx$group <- "sampling1+2"
p.2.bray.dist.xx <- reshapeDist(p.2.bray.dist,p.2,"Fecal.sample.name","Group","BE2")
p.2.bray.dist.xx$group <- "sampling1+2"
p1a2.bray.dist <- rbind(p.1.bray.dist.xx, p.2.bray.dist.xx)
colnames(p1a2.bray.dist)[1:2] <- c("Group","BE2")

rm(ps122)
for (i in seq(1,nrow(p12),2)){
  tmpd <- data.frame(ID1=as.character(p12$Fecal.sample.name[i]), ID2=as.character(p12$Fecal.sample.name[i+1]), dist=as.numeric(genus.bray.dist[p12$Fecal.sample.name[i],p12$Fecal.sample.name[i+1]]))
  if(exists("ps122")){
    ps122 <- rbind(ps122, tmpd)
  }else{
    ps122 <- tmpd
  }
}
ps122$group <- "same subject(1:2)"

bray.dat <- rbind(p1a2.bray.dist[,c(3:6)],ps122)
bray.dat$dist <- as.numeric(bray.dat$dist)
ggplot(bray.dat, aes(x=group, y=dist,fill=group))+geom_boxplot()+theme_classic()+ stat_compare_means(label = "p.format",method = "wilcox.test",size=3)+
  labs(title="", x="", y="distance(bray curitis)")
```
通过检测mgs，genus，gene的bray curitis距离可知，
  same subject(1:2) 来自同一个受试者第一次取样与第二次取样之间的距离
  sampling1+2 所有受试者第一次取样之间的距离和所有受试者第二次取样之间的距离
  
  同一受试者前后取样样本之间的差异显著小于，全部受试者第一次取样之间的差异和第二次取样之间的差异
  
>* Note: 后续分析时需要排除来自同一受试者的影响，采用的方法可以是：仅仅筛选受试者第一个样品进行分析

## spearman 相关性系数（第一次取样：第二次取样）
```{r}

cor(genus.prf[,1],genus.prf[,2],method="s",use="pairwise.complete.obs")

for (i in unique(p12$Patient.ID)){
  cor(genus.prf[,p12[p12$Patient.ID==i,5][1]], genus.prf[,p12[p12$Patient.ID==i,5][2]],method="s",use="pairwise.complete.obs")
}
```

## 取了两次样的样本，没有更换治疗方案的样本：更换了治疗方案的样本
```{r}
c2 <- p12%>%filter(Fecal.sample.name%in%diff2sam.g5)
c12 <- p12%>%filter(Patient.ID%in%c2$Patient.ID) # 不同疗法
s12 <- p12[-which(p12$Patient.ID%in%c12$Patient.ID),] # 相同疗法
c12.bray.dist <- genus.bray.dist[c12$Fecal.sample.name, c12$Fecal.sample.name]
s12.bray.dist <- genus.bray.dist[s12$Fecal.sample.name, s12$Fecal.sample.name]


rm(c122)
for (i in seq(1,nrow(c12.bray.dist),2)){
  tmpd <- data.frame(ID1=as.character(c12$Fecal.sample.name[i]),ID2=as.character(c12$Fecal.sample.name[i+1]), dist=as.numeric(c12.bray.dist[i,i+1]))
  if(exists("c122")){
    c122 <- rbind(c122, tmpd)
  }else{
    c122 <- tmpd
  }
}
c122$group <- "same subject(diff treatment)"


rm(s122)
for (i in seq(1,nrow(s12.bray.dist),2)){
  tmpd <- data.frame(ID1=as.character(s12$Fecal.sample.name[i]), ID2=as.character(s12$Fecal.sample.name[i+1]), dist=as.numeric(s12.bray.dist[i,i+1]))
  if(exists("s122")){
    s122 <- rbind(s122, tmpd)
  }else{
    s122 <- tmpd
  }
}
s122$group <- "same subject(same treatment)"


bray.dat <- rbind(c122,s122)
bray.dat$dist <- as.numeric(bray.dat$dist)
ggplot(bray.dat, aes(x=group, y=dist))+geom_boxplot()+theme_classic()+ stat_compare_means(label = "p.format",method = "wilcox.test",size=3)+
  labs(title="", x="", y="distance(bray curitis)")

```

通过检测mgs，genus，gene的bray curitis距离可知，
  same subject(same treatment) 同一个受试者两次取样时治疗方法相同，两次取样之间的距离
  same subject(diff treatment) 同一个受试者两次取样时治疗方法不同，两次取样之间的距离
  
  总体来看，这两种人群之间没有显著差异，但可能在特定的菌中有差异


## 广东/非广东人影响

查看分布情况
```{r}
phe$Patient.ID <- factor(phe$Patient.ID, levels=unique(gd$Patient.ID))

# 开始治疗时间节点-第一次取样时间节点
ggplot(phe, aes(x=Sampling.post.treatment.w., y=Patient.ID, color = Group, shape = Native.place)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +geom_point(size = 3) + 
  geom_line(aes(group=Patient.ID), linetype="dashed", col="black")+ 
  xlab("Days relative to initiation of treatment") + ylab("Patient ID")+theme_bw()#+scale_x_date(date_breaks = "1 month")

gd <- phe%>%filter(sample_order=="1"|sample_order=="-") # 筛选受试者第一次样本分析
gd <- gd[order(gd$Native.place),]
ggplot(data = gd, aes(x=Native.place, y=Sampling.post.treatment.w.)) + geom_boxplot()+ geom_point()+ stat_compare_means(label = "p.format") + theme_classic() + labs(x='',title='')

table(gd$Native.place,gd$BE2)
table(gd$Native.place,gd$Group)

# 广东人与非广东人匹配，排除其他因素影响
gd.dat <- rbind(
  cbind(set=1,gd%>%filter(Native.place == "Cantonese")),
  cbind(set=0,gd%>%filter(Native.place == "Non-cantonese")))

mat.gd <- pairmatch(set~Group+BE2,controls = 1, data=gd.dat)
xx <- gd.dat[which(!is.na(mat.gd)),]

table(xx$Native.place,xx$Group)
table(xx$Native.place,xx$BE2)
table(xx$Group, xx$BE2)
rownames(xx) <- xx$Fecal.sample.name

View(PermFun(mgs.bray.dist, xx, 5))
View(PermFun(All.genes.79.bray.dist, xx, 5))
View(PermFun(All.genus.79.bray.dist, xx, 5))
```

通过条件配对后得到的矩阵为xx，进行permuanova检验可知广东人群/非广东人群可能有明显差异？


```{r}
load("../Result/04.Globalview/1.Alpha/bmc.sum.BE3.Alp.RData")
aaa <- mgs.alp%>%filter(Fecal.sample.name%in%xx$Fecal.sample.name)
ggplot(data = aaa, aes(x=Native.place, y=Richness, fill=Native.place)) + geom_boxplot()+ stat_compare_means(label = "p.format") + theme_classic() + labs(x='',title='')
ggplot(data = aaa, aes(x=Native.place, y=Shannon, fill=Native.place)) + geom_boxplot()+ stat_compare_means(label = "p.format") + theme_classic() + labs(x='',title='')

```
分析已匹配的两组alpha多样性，其中多样性无显著差异


```{r}
pcoa_bray <- pcoa(mgs.bray.dist[xx$Fecal.sample.name, xx$Fecal.sample.name]) 
pcoa_data <- data.frame(pcoa_bray$vectors[,1:2])
colnames(pcoa_data) <- c("PCo1", "PCo2")
eig <- pcoa_bray$value[,1]
pc1 <- eig[1]/sum(eig)*100
pc2 <- eig[2]/sum(eig)*100 
pc1 <- paste0("PCo1(",round(pc1,2),"%)")
pc2 <- paste0("PCo2(",round(pc2,2),"%)")

### merge data frame
rownames(phe) <- phe$Fecal.sample.name
pcoa_data<-merge(pcoa_data, phe, by = "row.names")

ggplot(pcoa_data,aes(x=PCo1,y=PCo2,color=Native.place)) + geom_point() + stat_ellipse(aes(color=Native.place)) + xlab(pc1)+ylab(pc2) 

```
分析两组Beta多样性
以上分析可知，通过配对消除相对取样时间、疗效、分组差异后，广东人/非广东人之间可能存在影响
