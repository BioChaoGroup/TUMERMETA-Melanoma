---
title: "Compare the different species(mgs) of 50 melanoma samples"
author: "pengzhuobing"
date: "2021/3/16"
output:
  html_document: default
  pdf_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load fucntions
library(ggplot2)
library(dplyr)
library(reshape2)
library(pheatmap)
library(plyr)
library(RColorBrewer)
library(ComplexHeatmap)
library(patchwork)
library(ggpubr)
library(viridis)
source("./TEST.functions.R") #这里加载写好的功能，后面用到的ttFun，tkFun
do.write <- F
```

```{r, warning=FALSE}
#phenotype
load("../Result/01.Profile/phe1.RData")
phe <- phe.210701%>%filter(sample_order=="1"|sample_order=="-")
phe <- phe[order(phe$Fecal.sample.name),]  

# mgs.prf
prf <- read.table("../Result/02.gene2MGS/IGC.mgs.79.abundance.profile.txt", sep = "\t", row.names = 1, header = T)
prf <- prf[rowSums(prf)!=0,]

# trans to relative aboundance
prf <- prf/1000000  # total gene aboundance is 1000000

#for (i in 1:dim(prf)[2]){
#  rog5 = sum(prf[,i])
#  for (j in 1:dim(prf)[1]){
#    prf[j,i] <- prf[j,i]/rog5
#  }
#}

# mgs.annotation
mgs.V2.anno <- read.table("../Result/01.Profile/00.IGC.MGS.annotation",sep="\t",header=T) 
mgs.V2.anno$mgs.V2 <- sub(":",".",mgs.V2.anno$X)
mgs.V2.anno2 <- mgs.V2.anno[,c(8,2,3)]

#自定义显著性标记函数，此处显著性标记使用“*”
sig_label<-function(x){ifelse(x<0.001&x>0,"***",ifelse(x<0.01,"**",ifelse(x<0.05,"*","")))}
sig <- function(x){ifelse(x=="**", 23, ifelse(x=="*", 23, 21))}
#cols <- function(x){ifelse(x=="**", "3", ifelse(x=="*", "3", "2"))}

```


**The following is sample and grouping information: **
```{r,warning=FALSE,echo=FALSE}

# R : NR
BE2.gro <- phe

# sample info

# 10 group
table(BE2.gro$Drug_type, BE2.gro$BE2)
# 5 group
table(BE2.gro$Group, BE2.gro$BE2)
# 3 group
table(BE2.gro$Treatment_type, BE2.gro$BE2)

```



```{r}
### **Perform Kw test on 10 group/ 5 group**

# 10 group
table(BE2.gro$Drug_type)
#sel.g10.diff.aov.spe <- kwFun(prf, BE2.gro, "Fecal.sample.name", "Drug_type", NULL, ex.0=T)
 
table(BE2.gro$Group)
#sel.g5.diff.aov.spe <- aovFun(prf, BE2.gro, "Fecal.sample.name", "Group", NULL, ex.0=T)
```




### **Perform wilcox test on subgroup (R: NR) **

```{r,echo=FALSE}
BE2.prf <- select(prf, BE2.gro$Fecal.sample.name) 

if(do.write){
  sel.diff.spe <- ttFun(BE2.prf, BE2.gro, "Fecal.sample.name", "BE2", NULL,ex.0=T)
}


```


```{r}
# 3 group one by one
if(file.exists("../Result/03.Comparison/S50/bmc.sum.g3.BE2.w.RData")){
  load("../Result/03.Comparison/S50/bmc.sum.g3.BE2.w.RData")
}else{
  sum.g3.BE2.test <- NULL  
  for(i in levels(BE2.gro$Treatment_type)){
    tsi.phe <- BE2.gro%>%filter(Treatment_type==i)
    tsi.phe <- tsi.phe[order(interaction(tsi.phe$Treatment_type,tsi.phe$BE2)),]  
    rownames(tsi.phe) <- tsi.phe$Fecal.sample.name
    tsi.prf <- BE2.prf[,as.character(tsi.phe$Fecal.sample.name)] 
    ### tsi.g3.BE2.w <- aovFun(tsi.prf,tsi.phe,"DNAID","BE2","BMI",ex.0=F)
    tsi.phe$Fecal.sample.ID <- droplevels(tsi.phe$Fecal.sample.name)
    tsi.phe$BE2 <- droplevels(tsi.phe$BE2)
    tsi.g3.BE2.w <- ttFun(tsi.prf,tsi.phe,"Fecal.sample.name","BE2",NULL,ex.0=F) 
    #得到显著性标记矩阵
    tsi.g3.BE2.w$sig_FDR<-sig_label(tsi.g3.BE2.w$p.value)
    sum.g3.BE2.test[[i]] <- tsi.g3.BE2.w
    g <- ggplot(tsi.g3.BE2.w,aes(x=FDR,fill=Enrich)) + geom_histogram(position="stack") + xlim(c(0,1))
  }
  if(do.write){
    save(sum.g3.BE2.test,file="../Result/03.Comparison/S50/bmc.sum.g3.BE2.w.RData")
  }
}

sum.g3.wilcox.df <- rbind(
  cbind(group="ICT",sum.g3.BE2.test$ICT),
  cbind(group="ICT/Chemo",sum.g3.BE2.test$`ICT/Chemo`),
  cbind(group="ICT/Target",sum.g3.BE2.test$`ICT/Target`)
)


# 5 group one by one
if(file.exists("../Result/03.Comparison/S50/bmc.sum.g5.BE2.w.p50.RData")){
  load("../Result/03.Comparison/S50/bmc.sum.g5.BE2.w.p50.RData")
}else{
  sum.g5.BE2.test <- NULL  
  for(i in levels(BE2.gro$Group)){
    tsi.phe <- BE2.gro%>%filter(Group==i)
    tsi.phe <- tsi.phe[order(interaction(tsi.phe$Group,tsi.phe$BE2)),]  
    rownames(tsi.phe) <- tsi.phe$Fecal.sample.name
    tsi.prf <- BE2.prf[,as.character(tsi.phe$Fecal.sample.name)] 
    ### tsi.g5.BE2.w <- aovFun(tsi.prf,tsi.phe,"DNAID","BE2","BMI",ex.0=F)
    tsi.phe$Fecal.sample.ID <- droplevels(tsi.phe$Fecal.sample.name)
    tsi.phe$BE2 <- droplevels(tsi.phe$BE2)
    tsi.g5.BE2.w <- ttFun(tsi.prf,tsi.phe,"Fecal.sample.name","BE2",NULL,ex.0=F) 
    #得到显著性标记矩阵
    tsi.g5.BE2.w$sig_FDR<-sig_label(tsi.g5.BE2.w$p.value)
    sum.g5.BE2.test[[i]] <- tsi.g5.BE2.w
    g <- ggplot(tsi.g5.BE2.w,aes(x=FDR,fill=Enrich)) + geom_histogram(position="stack") + xlim(c(0,1))
  }
  if(do.write){
    save(sum.g5.BE2.test,file="../Result/03.Comparison/S50/bmc.sum.g5.BE2.w.p50.RData")
  }
}

sum.g5.wilcox.df <- rbind(
  cbind(group="ICT",sum.g5.BE2.test$ICT),
  cbind(group="ICT.BRAF",sum.g5.BE2.test$`ICT.BRAF`),
  cbind(group="ICT.PTX",sum.g5.BE2.test$`ICT.PTX`),
  cbind(group="ICT.TKI",sum.g5.BE2.test$`ICT.TKI`),
  cbind(group="ICT.TMZ",sum.g5.BE2.test$`ICT.TMZ`)
)



```



#### **1. P.value distribution**

```{r,echo=FALSE}

ggplot(sum.g5.wilcox.df%>%filter(Pct>20&Occ.>0.2), #
       aes(x=p.value,color=group)) + geom_density()
```


#### **2. ICT group R:NR (P < 0.05)** 
```{r}
ict.sum.wilcox.df <- sum.g5.wilcox.df%>%filter(group=="ICT" & p.value < 0.05 & Pct >= 20 & Occ.>0.2 &(median.NR > 0 | median.R > 0))
ict.gro <- BE2.gro[which(BE2.gro$Group=="ICT"),c("Patient.ID","Fecal.sample.name","sample_order","Sampling.post.treatment.w.","Group","BE2")]

# 中位数绘制柱状图
ict.median <- ict.sum.wilcox.df[,c("mgs.V2","median.NR","median.R")]
ict.median <- melt(ict.median, id = 'mgs.V2')
ex0.mgs <- ict.median[which(ict.median$value!=0),"mgs.V2"] # 去除BE2两组中位数均为0的
res <- full_join(ict.median, ict.sum.wilcox.df[,c("group","mgs.V2","MainTax","Pct","NR","R","Occ.","Enrich","p.value","FDR","sig_FDR")])
res <- res[order(res$value),]
res$mgs.V2 <- factor(res$mgs.V2, levels = unique(rev(res$mgs.V2)))

pA <- ggplot() + geom_bar(data=res%>%filter(mgs.V2%in%ex0.mgs),aes(x=mgs.V2,y=value,fill=variable), stat = "identity", position="dodge",width=0.9) +theme(axis.text.x = element_text(angle = 30, hjust = 1))+coord_cartesian(ylim = c(0,5e-5)) #+scale_y_log10()#+ labs(x='sign mgs',y='Relative abundance')+theme_classic()

pB <- ggplot() + geom_bar(data=res%>%filter(mgs.V2%in%ex0.mgs),aes(x=mgs.V2,y=value,fill=variable), stat = "identity", position="dodge",width=0.9) +theme(axis.text.x = element_blank(),axis.ticks.x = element_blank())+coord_cartesian(ylim = c(5e-5,2.5e-4)) + scale_y_continuous(breaks = c(0.00005,0.00025,1e-5))+labs(x=NULL,y=NULL,fill=NULL) #以5为单位划分Y轴#+scale_y_log10()#+ labs(x='sign mgs',y='Relative abundance')+theme_classic()

pAB <- ggarrange(pB,pA,heights=c(1/6, 5/6),ncol = 1, nrow = 2,common.legend = TRUE,legend="right",align = "v") 
pAB

if(do.write){
  ggsave(pAB,height = 4, width = 8, filename = "../Result/03.Comparison/S50/bmc.ict.BE2.w.signmgs0.05.p50.barplot1.pdf")
}

# res$value[res$value == 0] <- 1e-12
# res$value <- -log2(res$value)
# res$value <- 1/res$value
# ggplot() + geom_bar(data=res,aes(x=mgs.V2,y=value,fill=variable), stat = "identity", position="dodge") +theme(axis.text.x = element_text(angle = 30, hjust = 1))

# 绘制箱线图
ict.sign.prf <- BE2.prf[as.character(ict.sum.wilcox.df$mgs.V2), as.character(ict.gro$Fecal.sample.name)]
ict.sign.prf$mgs.V2 <- factor(rownames(ict.sign.prf), levels = rownames(ict.sign.prf))
ict.sign.prf <- melt(ict.sign.prf, id = 'mgs.V2')
names(ict.sign.prf)[2] <- 'Fecal.sample.name'
res <- full_join(ict.sign.prf, ict.gro)
res <- full_join(res, ict.sum.wilcox.df[,c(2,3)])
res <- res[order(res$value),]
res$mgs.V2 <- factor(res$mgs.V2, levels = unique(rev(res$mgs.V2)))
res$value[which(res$value==0)] <- 1e-10
p0.5.ict.a <- ggplot(res, aes(x=mgs.V2, y=value, fill=BE2)) + geom_boxplot(outlier.shape = NA) +stat_compare_means(aes(group= BE2),size=3,label = "p.signif") + scale_fill_viridis(discrete = TRUE, alpha=0.6)+ labs(x='sign mgs',y='Relative abundance(log 10)')+ scale_y_log10()+theme_classic()+theme(axis.text.x = element_text(angle = 30, hjust = 1),axis.ticks.x = element_blank())
p0.5.ict.a

if (do.write){
  ggsave(p0.5.ict.a, height =4, width = 8, filename = "../Result/03.Comparison/S50/bmc.ict.BE2.w.signmgs0.05.p50.all.pdf")
}

p0.5.ict <- ggplot(res, aes(x=BE2, y=value,fill=BE2)) + geom_boxplot(outlier.shape = NA) +stat_compare_means(aes(group= BE2),size=3,label = "p.signif") + labs(x='signficant mgs(ICT)',y='Relative abundance')+ facet_wrap(mgs.V2~MainTax, scales = "free_y", nrow = 5)+theme_classic()
p0.5.ict

if (do.write){
  ggsave(p0.5.ict, height = 12, width = 18, filename = "../Result/03.Comparison/S50/bmc.ict.BE2.w.signmgs0.05.p50.pdf")
}


## 差异物种用热图表达
matrixA <- BE2.prf[as.character(ict.sum.wilcox.df$mgs.V2), as.character(ict.gro$Fecal.sample.name)]
matrixA[matrixA == 0] <- 1e-10
matrixA <- apply(matrixA, 2, function(x) log10(x)) #使用log 标准化
matrixA <- t(matrixA)

#添加注释信息
annot_data_group <- data.frame(row.names = ict.gro$Fecal.sample.name, group = ict.gro$BE2)
annot_data_group$group <- factor(annot_data_group$group, levels=c("R","NR"))
annot_data_sign <- data.frame(row.names = ict.sum.wilcox.df$mgs.V2, Enrich = ict.sum.wilcox.df$Enrich)
matrixA <- matrixA[order(ict.gro$BE2),]
annot_data_sign <- data.frame(row.names = ict.sum.wilcox.df$mgs.V2, Enrich = ict.sum.wilcox.df$Enrich)
sort.mgs <- c("MGS.igc0306", "MGS.igc0693", "MGS.igc0928", "MGS.igc0393", "MGS.igc0631", "MGS.igc1118", "MGS.igc0051", "MGS.igc1102", "MGS.igc0312", "MGS.igc1047", "MGS.igc0565", "MGS.igc0797", "MGS.igc0996", "MGS.igc1192", "MGS.igc0899", "MGS.igc1155", "MGS.igc0837", "MGS.igc0261", "MGS.igc1482", "MGS.igc0205", "MGS.igc0166", "MGS.igc0237", "MGS.igc0906", "MGS.igc0686", "MGS.igc0936", "MGS.igc1414", "MGS.igc0039", "MGS.igc0102", "MGS.igc0204", "MGS.igc0076", "MGS.igc1263")


phe.p <- pheatmap(mat = matrixA, 
         # 边框颜色
         border_color = NA,
         # 是否进行聚类
         fontsize_row = 7.5,
         fontsize_col = 7.5,
         angle_col = 315,
         cluster_row = F,  cluster_col = T,
         clustering_method = "complete",
         # 分割热图
         annotation_row = annot_data_group,
         annotation_col = annot_data_sign,
         gaps_row = 12
         )

phe.p

if(do.write){
  ggsave(phe.p, width=7, heigh=5, filename = "../Result/03.Comparison/S50/bmc.ict.BE2.w.signmgs0.05.p50.heatmap.pdf")
}
```


#### **3. P.value statistics**

P.value < 0.01:
```{r,echo=FALSE}
select.mgs.0.01 <- sum.g5.wilcox.df%>%filter(p.value < 0.01 & Pct >= 20 & Occ.>0.2)
table(select.mgs.0.01$group, select.mgs.0.01$Enrich)

if (do.write){
  write.csv(select.mgs.0.01, file = "../Result/03.Comparison/S50/bmc.sum.g5.BE2.w.diff.P_0.01.50.csv")
}


```

P.value < 0.05:
```{r,echo=FALSE}
select.mgs.0.05 <- sum.g5.wilcox.df%>%filter(p.value < 0.05 & Pct >= 20 & Occ.>0.2)
table(select.mgs.0.05$group, select.mgs.0.05$Enrich)


if (do.write){
  write.csv(select.mgs.0.05, file = "../Result/03.Comparison/S50/bmc.sum.g5.BE2.w.diff.P_0.05.50.csv")
}
```


```{r}
# select mgs
select.mgs <- select.mgs.0.05
select.mgs <- unique(select.mgs$mgs.V2)
sign.sum.g5.wilcox.df <- sum.g5.wilcox.df%>%filter(mgs.V2%in%select.mgs) # sign.sum.g5.wilcox.df 筛选至少在一组中R：NR有显著差异的mgs

```


#### **4. show enriched (P < 0.01)** 

```{r, echo=FALSE}
R.g5.median.matrix <- dcast(sign.sum.g5.wilcox.df,mgs.V2~group,value.var = "median.R")
NR.g5.median.matrix <- dcast(sign.sum.g5.wilcox.df,mgs.V2~group,value.var = "median.NR")
sum.g5.median.matrix <- cbind(R.g5.median.matrix,NR.g5.median.matrix[,-1])
colnames(sum.g5.median.matrix)[2:11] <- paste0(colnames(sum.g5.median.matrix)[2:11],rep(c("_R","_NR"),each=5))
rownames(sum.g5.median.matrix) <- sum.g5.median.matrix[,1]
sum.g5.median.matrix <- sum.g5.median.matrix[,-1]

sum.g5.median.matrix <- apply(sum.g5.median.matrix,1:2,function(x) ifelse(is.na(x),0,x))
sum.g5.median.matrix <- apply(sum.g5.median.matrix,1:2,function(x) ifelse(x==0,-10,log10(x)))

#
R.g5.signif.matrix <- dcast(sign.sum.g5.wilcox.df%>%filter(Enrich=="R"),
                             mgs.V2~group,value.var = "p.value")
NR.g5.signif.matrix <- dcast(sign.sum.g5.wilcox.df%>%filter(Enrich=="NR"),
                                mgs.V2~group,value.var = "p.value")



sum.g5.signif.matrix <- matrix(NA,ncol=ncol(sum.g5.median.matrix),
                               nrow=nrow(sum.g5.median.matrix),
                               dimnames=dimnames(sum.g5.median.matrix))

sum.g5.signif.matrix[R.g5.signif.matrix$mgs.V2, 0 + 1:5] <- sig_label(R.g5.signif.matrix[,-1])   #ifelse(R.g5.signif.matrix[,-1]<0.05,"*",NA)

sum.g5.signif.matrix[NR.g5.signif.matrix$mgs.V2, 5 + 1:5] <- sig_label(NR.g5.signif.matrix[,-1]) #ifelse(NR.g5.signif.matrix[,-1]<0.05,"*",NA)

sum.g5.signif.matrix <- apply(sum.g5.signif.matrix,1:2,function(x) ifelse(is.na(x),"",x))

## plot1
#sum.g5.median.matrix <- sum.g5.median.matrix[,rev(sort(colnames(sum.g5.median.matrix)))] # 排序
#sum.g5.signif.matrix <- sum.g5.signif.matrix[,rev(sort(colnames(sum.g5.signif.matrix)))] 
#phWd <- pheatmap(sum.g5.median.matrix,cluster_rows = T,cluster_cols = F,
#         color=c("#CCCCCC",colorRampPalette(brewer.pal(n = 11, name ="RdYlGn"))(11)),
#         gaps_col = c(2,4,6,8,10),display_numbers = sum.g5.signif.matrix,
#         #breaks=rev(c(1,0.7,0.5,0.2,0.1,0.05,0.01,0.005,0.001,0.0005,0))
#)
#phWd

phWd <- pheatmap(sum.g5.median.matrix,cluster_rows = T,cluster_cols = F,
         color=c("#CCCCCC",colorRampPalette(brewer.pal(n = 11, name ="RdYlGn"))(11)),
         gaps_col = c(5,10),display_numbers = sum.g5.signif.matrix,
         #breaks=rev(c(1,0.7,0.5,0.2,0.1,0.05,0.01,0.005,0.001,0.0005,0))
)

phWd


info <- mgs.V2.anno2%>%filter(mgs.V2 %in% rownames(sum.g5.median.matrix))
info[,1:2]

if (do.write){
  ggsave(phWd, height = 15, width = 7, filename = "../Result/03.Comparison/S50/bmc.sum.g5.BE2.w.diff.P_0.05.50.pdf")
}

```



```{r,echo=FALSE}

# cluster by "hclust"

out.dist=dist(sum.g5.median.matrix,method="euclidean")
out.hclust=hclust(out.dist,method="complete")
plot(out.hclust)


sum.g5.median.matrix <- sum.g5.median.matrix[out.hclust$order, ]

```


```{r}
## plot2

value <- rep(0.5, dim(sum.g5.median.matrix)[1])
ICT <- sign.sum.g5.wilcox.df%>%filter(group == "ICT")
ICT.BRAF <- sign.sum.g5.wilcox.df%>%filter(group == "ICT.BRAF")
ICT.PTX <- sign.sum.g5.wilcox.df%>%filter(group == "ICT.PTX")
ICT.TKI <- sign.sum.g5.wilcox.df%>%filter(group == "ICT.TKI")
ICT.TMZ <- sign.sum.g5.wilcox.df%>%filter(group == "ICT.TMZ")
ICT <- ICT[out.hclust$order, ]
ICT.BRAF <- ICT.BRAF[out.hclust$order, ]
ICT.PTX <- ICT.PTX[out.hclust$order, ]
ICT.TKI <- ICT.TKI[out.hclust$order, ]
ICT.TMZ <- ICT.TMZ[out.hclust$order, ]


annotation = HeatmapAnnotation("ICT_P_value" = anno_points(value, pch = sig(ICT$sig_FDR), axis = F, size = unit(5, "mm"),axis_param = NULL,border=FALSE,show_annotation_name = FALSE,ylim=c(0,1),gp = gpar(fill = ifelse(ICT$sig_FDR=="**", "#207f4c", ifelse(ICT$sig_FDR=="*","#8cc269", "#f1f0ed")))),
                               "ICT.TMZ_P_value" = anno_points(value, axis = F, pch = sig(ICT.TMZ$sig_FDR),size = unit(5, "mm"),axis_param = NULL,border=FALSE,show_annotation_name = FALSE,ylim=c(0,1),gp = gpar(fill = ifelse(ICT.TMZ$sig_FDR=="**", "#207f4c", ifelse(ICT.TMZ$sig_FDR=="*","#8cc269", "#f1f0ed")))), 
                               "ICT.TKI_P_value" = anno_points(value, axis = F, pch = sig(ICT.TKI$sig_FDR),size = unit(5, "mm"),axis_param = NULL,border=FALSE,show_annotation_name = FALSE,ylim=c(0,1),gp = gpar(fill = ifelse(ICT.TKI$sig_FDR=="**", "#207f4c", ifelse(ICT.TKI$sig_FDR=="*","#8cc269", "#f1f0ed")))),
                               "ICT.PTX_P_value" = anno_points(value, axis = F, pch = sig(ICT.PTX$sig_FDR),size = unit(5, "mm"),axis_param = NULL,border=FALSE,show_annotation_name = FALSE,ylim=c(0,1),gp = gpar(fill = ifelse(ICT.PTX$sig_FDR=="**", "#207f4c", ifelse(ICT.PTX$sig_FDR=="*","#8cc269", "#f1f0ed")))),
                              
                               "ICT.BRAF_P_value" = anno_points(value, axis = F, pch = sig(ICT.BRAF$sig_FDR),size = unit(5, "mm"),axis_param = NULL,border=FALSE,show_annotation_name = FALSE,ylim=c(0,1),gp = gpar(fill = ifelse(ICT.BRAF$sig_FDR=="**", "#207f4c", ifelse(ICT.BRAF$sig_FDR=="*","#8cc269", "#f1f0ed")))))

sum.g5.median.matrix <- sum.g5.median.matrix[,rev(sort(colnames(sum.g5.median.matrix)))] # 排序

# plot
if (do.write){
  pdf("../Result/03.Comparison/S50/bmc.sum.g5.BE2.w.diff.P_0.05_1.50.pdf", width = 18, height = 5.5)
}

Heatmap(t(sum.g5.median.matrix), cluster_rows = F, cluster_columns = F, rect_gp = gpar(col = "grey50", lwd = 1),bottom_annotation = annotation, row_gap = unit(4, "mm"), heatmap_legend_param = list(title = ""))
#Heatmap(t(sum.g5.median.matrix), cluster_rows = F, cluster_columns = T, bottom_annotation = annotation, col = c("#d7191c", "#fdae61","#ffffbf","#a6d96a", "#1a9641"))
#Heatmap(t(sum.g5.median.matrix), cluster_rows = F, cluster_columns = T, bottom_annotation = annotation, col = c("#a6611a", "#dfc27d","#f5f5f5","#80cdc1", "#018571"))
if (do.write){
  dev.off()
}
```




```{r, running = FALSE}
## plot3

annotation_ICT = rowAnnotation("ICT_P_value" = anno_points(value, axis = F, pch = sig(ICT$sig_FDR),size = unit(3, "mm"),axis_param = NULL,border=FALSE,show_annotation_name = FALSE,ylim=c(0,1.5), gp = gpar(fill = ifelse(ICT$sig_FDR=="**", "#207f4c", ifelse(ICT$sig_FDR=="*","#8cc269", "#f1f0ed")))))
annotation_ICT.BRAF = rowAnnotation("ICT.BRAF_P_value" = anno_points(value, axis = F, pch = sig(ICT.BRAF$sig_FDR),size = unit(3, "mm"),axis_param = NULL,border=FALSE,show_annotation_name = FALSE,ylim=c(0,1.5),gp = gpar(fill = ifelse(ICT.BRAF$sig_FDR=="**", "#207f4c", ifelse(ICT.BRAF$sig_FDR=="*","#8cc269", "#f1f0ed")))))
annotation_ICT.PTX = rowAnnotation("ICT.PTX_P_value" = anno_points(value, axis = F, pch = sig(ICT.PTX$sig_FDR),size = unit(3, "mm"),axis_param = NULL,border=FALSE,show_annotation_name = FALSE,ylim=c(0,1.5),gp = gpar(fill = ifelse(ICT.PTX$sig_FDR=="**", "#207f4c", ifelse(ICT.PTX$sig_FDR=="*","#8cc269", "#f1f0ed")))))
annotation_ICT.TKI = rowAnnotation("ICT.TKI_P_value" = anno_points(value, axis = F, pch = sig(ICT.TKI$sig_FDR),size = unit(3, "mm"),axis_param = NULL,border=FALSE,show_annotation_name = FALSE,ylim=c(0,1.5),gp = gpar(fill = ifelse(ICT.TKI$sig_FDR=="**", "#207f4c", ifelse(ICT.TKI$sig_FDR=="*","#8cc269", "#f1f0ed")))))
annotation_ICT.TMZ = rowAnnotation("ICT.TMZ_P_value" = anno_points(value, axis = F, pch = sig(ICT.TMZ$sig_FDR),size = unit(3, "mm"),axis_param = NULL,border=FALSE,show_annotation_name = FALSE,ylim=c(0,1.5),gp = gpar(fill = ifelse(ICT.TMZ$sig_FDR=="**", "#207f4c", ifelse(ICT.TMZ$sig_FDR=="*","#8cc269", "#f1f0ed")))))

p.ict <- Heatmap(sum.g5.median.matrix[,c(1,2)], cluster_rows = F, cluster_columns = F,  row_labels = rep("", dim(sum.g5.median.matrix)[1]),  right_annotation = annotation_ICT,show_heatmap_legend = FALSE)

p.ict.tm <- Heatmap(sum.g5.median.matrix[,c(3,4)], cluster_rows = F, cluster_columns = F, right_annotation = annotation_ICT.TMZ, row_labels = rep("", dim(sum.g5.median.matrix)[1]),show_heatmap_legend = FALSE)

p.ict.p <- Heatmap(sum.g5.median.matrix[,c(5,6)], cluster_rows = F, cluster_columns = F, right_annotation = annotation_ICT.PTX, row_labels = rep("", dim(sum.g5.median.matrix)[1]),show_heatmap_legend = FALSE)

p.ict.t <- Heatmap(sum.g5.median.matrix[,c(7,8)], cluster_rows = F, cluster_columns = F, right_annotation = annotation_ICT.TKI,  row_labels = rep("", dim(sum.g5.median.matrix)[1]),show_heatmap_legend = FALSE)

p.ict.b <- Heatmap(sum.g5.median.matrix[,c(9,10)], cluster_rows = F, cluster_columns = F, right_annotation = annotation_ICT.BRAF)


# plot
#pdf("./ICT.pdf", width = 13, height = 1)

p.ict + p.ict.b + p.ict.p + p.ict.t + p.ict.tm

#dev.off()

p.ict + p.ict.b


```






